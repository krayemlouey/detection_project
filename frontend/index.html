<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - Syst√®me de D√©tection</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div class="container">
        <header>
            <h1>üéØ Dashboard de D√©tection</h1>
            <p>Surveillance en temps r√©el</p>
        </header>

        <div class="main-grid">
            <!-- Zone Cam√©ra -->
            <div class="camera-section">
                <h2>üìπ Cam√©ra en Direct</h2>
                <div class="camera-container">
                    <video id="videoElement" autoplay muted></video>
                    <canvas id="canvasElement" style="display:none;"></canvas>
                </div>
                <div class="camera-controls">
                    <button id="startBtn" class="btn btn-primary">D√©marrer Cam√©ra</button>
                    <button id="stopBtn" class="btn btn-secondary" disabled>Arr√™ter</button>
                </div>
                <div class="status" id="cameraStatus">Cam√©ra arr√™t√©e</div>
            </div>

            <!-- Zone D√©tections -->
            <div class="detection-section">
                <h2>üîç D√©tections en Cours</h2>
                <div class="detection-stats">
                    <div class="stat-card red">
                        <h3>üî¥ Rouge</h3>
                        <span id="redCount">0</span>
                        <small>Cartes Microchip</small>
                    </div>
                    <div class="stat-card green">
                        <h3>üü¢ Vert</h3>
                        <span id="greenCount">0</span>
                        <small>Cartes Personnalis√©es</small>
                    </div>
                    <div class="stat-card blue">
                        <h3>üîµ Bleu</h3>
                        <span id="blueCount">0</span>
                        <small>STM32</small>
                    </div>
                </div>
            </div>

            <!-- Zone Captures -->
            <div class="captures-section">
                <h2>üì∏ Derni√®res Captures</h2>
                <div id="capturesContainer" class="captures-grid">
                    <div class="no-captures">Aucune capture pour le moment</div>
                </div>
            </div>
        </div>

        <!-- Zone Log -->
        <div class="log-section">
            <h3>üìã Log des D√©tections</h3>
            <div id="logContainer" class="log-container">
                <div class="log-entry">Syst√®me d√©marr√© - En attente...</div>
            </div>
        </div>
    </div>

    <script>
        class DetectionDashboard {
            constructor() {
                this.videoElement = document.getElementById('videoElement');
                this.canvasElement = document.getElementById('canvasElement');
                this.startBtn = document.getElementById('startBtn');
                this.stopBtn = document.getElementById('stopBtn');
                this.cameraStatus = document.getElementById('cameraStatus');
                this.logContainer = document.getElementById('logContainer');
                this.capturesContainer = document.getElementById('capturesContainer');
                
                this.stream = null;
                this.detectionInterval = null;
                this.counts = { red: 0, green: 0, blue: 0 };
                
                this.initializeEvents();
            }

            initializeEvents() {
                this.startBtn.addEventListener('click', () => this.startCamera());
                this.stopBtn.addEventListener('click', () => this.stopCamera());
            }

            async startCamera() {
                try {
                    this.stream = await navigator.mediaDevices.getUserMedia({
                        video: { width: 640, height: 480 }
                    });
                    
                    this.videoElement.srcObject = this.stream;
                    this.startBtn.disabled = true;
                    this.stopBtn.disabled = false;
                    this.cameraStatus.textContent = 'Cam√©ra active - D√©tection en cours';
                    this.cameraStatus.className = 'status active';
                    
                    // D√©marrer la d√©tection automatique
                    this.startDetection();
                    this.addLog('‚úÖ Cam√©ra d√©marr√©e - D√©tection automatique activ√©e');
                    
                } catch (error) {
                    console.error('Erreur cam√©ra:', error);
                    this.addLog('‚ùå Erreur: Impossible d\'acc√©der √† la cam√©ra');
                }
            }

            stopCamera() {
                if (this.stream) {
                    this.stream.getTracks().forEach(track => track.stop());
                    this.stream = null;
                }
                
                if (this.detectionInterval) {
                    clearInterval(this.detectionInterval);
                }
                
                this.startBtn.disabled = false;
                this.stopBtn.disabled = true;
                this.cameraStatus.textContent = 'Cam√©ra arr√™t√©e';
                this.cameraStatus.className = 'status';
                this.addLog('‚èπÔ∏è Cam√©ra arr√™t√©e');
            }

            startDetection() {
                // D√©tection toutes les 2 secondes
                this.detectionInterval = setInterval(() => {
                    this.captureAndDetect();
                }, 2000);
            }

            captureAndDetect() {
                if (!this.stream) return;

                const canvas = this.canvasElement;
                const ctx = canvas.getContext('2d');
                
                canvas.width = this.videoElement.videoWidth;
                canvas.height = this.videoElement.videoHeight;
                
                ctx.drawImage(this.videoElement, 0, 0);
                
                // Simuler une d√©tection (remplacer par vraie d√©tection OpenCV)
                const detection = this.simulateDetection();
                
                if (detection) {
                    this.processDetection(detection);
                    this.captureImage(canvas, detection);
                }
            }

            simulateDetection() {
                // Simulation simple - remplacer par la vraie d√©tection
                if (Math.random() > 0.7) {
                    const colors = ['red', 'green', 'blue'];
                    const types = ['Carte microchip', 'Carte personnalis√©e', 'STM32'];
                    const color = colors[Math.floor(Math.random() * colors.length)];
                    
                    return {
                        color: color,
                        type: types[colors.indexOf(color)],
                        confidence: Math.random() * 0.3 + 0.7
                    };
                }
                return null;
            }

            processDetection(detection) {
                this.counts[detection.color]++;
                document.getElementById(detection.color + 'Count').textContent = this.counts[detection.color];
                
                const timestamp = new Date().toLocaleString('fr-FR');
                this.addLog(`üéØ D√©tection: ${detection.type} (${detection.color}) - ${timestamp}`);
                
                // Sauvegarder in database
                this.saveToDatabase(detection);
            }

            async saveToDatabase(detection) {
                const data = {
                    g_id: `${detection.color.toUpperCase()}_${detection.type.replace(/\s+/g, '_')}_${Date.now()}`,
                    object_type: detection.type,
                    color: detection.color,
                    datetime: new Date().toISOString()
                };

                try {
                    const response = await fetch('http://localhost:3000/api/detections', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(data)
                    });
                    
                    if (response.ok) {
                        console.log('Sauvegarde r√©ussie:', data);
                    }
                } catch (error) {
                    console.error('Erreur sauvegarde:', error);
                }
            }

            captureImage(canvas, detection) {
                const imageData = canvas.toDataURL('image/jpeg', 0.8);
                const timestamp = new Date().toLocaleString('fr-FR');
                const filename = `capture_${detection.color}_${Date.now()}.jpg`;
                
                // Ajouter √† la zone captures
                this.addCapture(imageData, detection, timestamp, filename);
            }

            addCapture(imageData, detection, timestamp, filename) {
                if (this.capturesContainer.querySelector('.no-captures')) {
                    this.capturesContainer.innerHTML = '';
                }

                const captureDiv = document.createElement('div');
                captureDiv.className = 'capture-item';
                captureDiv.innerHTML = `
                    <img src="${imageData}" alt="Capture ${detection.color}">
                    <div class="capture-info">
                        <strong>${detection.type}</strong>
                        <span class="color-badge ${detection.color}">${detection.color}</span>
                        <small>${timestamp}</small>
                        <div class="filename">${filename}</div>
                    </div>
                `;
                
                this.capturesContainer.insertBefore(captureDiv, this.capturesContainer.firstChild);
                
                // Garder seulement les 6 derni√®res captures
                while (this.capturesContainer.children.length > 6) {
                    this.capturesContainer.removeChild(this.capturesContainer.lastChild);
                }
            }

            addLog(message) {
                const logEntry = document.createElement('div');
                logEntry.className = 'log-entry';
                logEntry.textContent = message;
                
                this.logContainer.insertBefore(logEntry, this.logContainer.firstChild);
                
                // Garder seulement les 10 derniers logs
                while (this.logContainer.children.length > 10) {
                    this.logContainer.removeChild(this.logContainer.lastChild);
                }
            }
        }

        // Initialiser l'application
        document.addEventListener('DOMContentLoaded', () => {
            new DetectionDashboard();
        });
    </script>
</body>
</html>